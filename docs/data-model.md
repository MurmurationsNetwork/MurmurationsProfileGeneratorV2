# MPG Data Model

The aim is to have a low latency storage layer so that a profile can immediately be served to the Index, but it will also be archived in IPFS so that profiles can be optimized for bulk reads from the network.

The data will be stored in one or two locations:

1. MongoDB (low latency, low redundancy) - it's fast, but it's a single point of failure (SPoF)
2. IPFS (higher latency, higher redundancy) - slower, but data can be distributed (removes SPoF)

The user data will be stored primarily in 1, but the profile data will be stored in both 1 & 2.

## Users

### MongoDB

The `users` collection in the `mpgdata` MongoDB:

- `email_hash` (string - hashed email) - hashed using `SHA256` (`dude@dev.null => 5e64eab91e34c4d6eddc1f515f9ce81dea8238249f0946d40e3fc9ca22b7031a`)
- `last_login` (number - Unix timestamp) - last time the user logged in
- `password` (string - hashed password) - hashed using [`brcryptjs`](https://www.npmjs.com/package/bcryptjs)
- `profiles` (array of strings) - each string is a unique identifier of a JSON Schema profile instance

```
{
  "email_hash":"5e64eab91e34c4d6eddc1f515f9ce81dea8238249f0946d40e3fc9ca22b7031a",
  "last_login":1652814514172,
  "password":"$2a$10$YzTuuQJfthIxVja/WZGh5OxjhSeMqQnG2xtOSUMAP41oTBkpNrMRq",
  "profiles": ["cjld2cjxh0000qzrmn831i7rn","cjld2cyuq0000t3rmniod1foy"]
}
```

## Profiles

### MongoDB

The `profiles` collection in the `mpgdata` MongoDB:

- `cuid` (string - generated by [`cuid`](https://www.npmjs.com/package/cuid)) - unique identifier of the JSON Schema profile instance
- `ipfs` (string) - IPFS address of the profile instance
- `last_updated` (number - Unix timestamp) - last time the user modified (or created) the profile
- `linked_schemas` (array of strings) - the schema(s) the profile must be validated against
- `title` (string) - a memorable/identifiable title to its author 

```
{
  "cuid":"cjld2cjxh0000qzrmn831i7rn",
  "ipfs":["bafybeif3kgstillrp22zqhq5occk6tyo2u2qa4e7s2yqpkia6ex2r3n23u"],
  "last_updated":1654738391000,
  "linked_schemas":["test_schema-v2.0.0"],
  "profile":{"linked_schemas":["test_schema-v2.0.0"],"name":"The Dude","latitude":1,"longitude":1},
  "title": "My first test profile"
}
```

### IPFS

The value is just the profile itself:

```
{"linked_schemas":["test_schema-v2.0.0"],"name":"The Dude","latitude":1,"longitude":1}
```

From the profile the IPFS address is generated and then stored for the user in the user record's `profile.ipfs` property in the `users` collection.
