# MPG Data Model

The aim is to have a low latency storage layer so that a profile can immediately be served to the Index, but also by an archiving/CDN layer that is optimized for bulk reads from the network.

The data model is based on a key/value store that is stored in two locations:

1. MongoDB (low latency, low redundancy) - it's fast, but it's a single point of failure (SPoF)
2. IPFS (higher latency, higher redundancy) - slower, but data can be distributed (removes SPoF)

The user data will be stored primarily in 1, but the profile data will be stored in both 1 & 2.

## Users

### Key

The key is a SHA256 hash of the users email address:

`dude@dev.null => 5e64eab91e34c4d6eddc1f515f9ce81dea8238249f0946d40e3fc9ca22b7031a`

### Value

The value is a JSON object that contains the following properties:

- `last_login` (number - Unix timestamp) - last time the user logged in
- `password` (string - hashed password) - hashed using [brcryptjs](https://www.npmjs.com/package/bcryptjs)
- `profiles` (array of objects) - each object includes:
  - `id` (string - generated by `cuid`) - unique identifier of the JSON Schema profile instance
  - `ipfs` (string) - IPFS address of the profile instance
  - `last_updated` (number - Unix timestamp) - last time the user modified (or created) the profile
  - `linked_schemas` (array of strings) - the schema(s) the profile must be validated against

```
{
  "last_login":1652814514172,
  "password":"$2a$10$YzTuuQJfthIxVja/WZGh5OxjhSeMqQnG2xtOSUMAP41oTBkpNrMRq",
  "profiles": [
    {
      "id":"cjld2cjxh0000qzrmn831i7rn",
      "ipfs":"bafybeif3kgstillrp22zqhq5occk6tyo2u2qa4e7s2yqpkia6ex2r3n23u",
      "last_updated":1654738391000,
      "linked_schemas":["test_schema-v2.0.0"]
    },
    {
      "id":"cjld2cyuq0000t3rmniod1foy",
      "ipfs":"bafybeigh3ixlaipnzsdh2u4iqqsi2cwjvgdpkcu4chmilfhjulbe4v5bpq",
      "last_updated":1654865732000
      "linked_schemas":["test_schema-v2.0.0","some_other_schema-v1.1.0"]
    }
  ]
}
```

## Profiles

### Key

The key is a unique ID generated by [cuid](https://www.npmjs.com/package/cuid).

### Value

The value is just the profile itself:

```
{"linked_schemas":["test_schema-v2.0.0"],"name":"The Dude","latitude":1,"longitude":1}
```
