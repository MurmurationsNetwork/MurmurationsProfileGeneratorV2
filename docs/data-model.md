# MPG Data Model

The aim is to have a low latency storage layer so that a profile can immediately be served to the Index, but it will also be archived in IPFS so that profiles can be optimized for bulk reads from the network.

The data will be stored in one or two locations:

1. MongoDB (low latency, low redundancy) - it's fast, but it's a single point of failure (SPoF)
2. IPFS (higher latency, higher redundancy) - slower, but data can be distributed (removes SPoF), and is also useful as a cache (e.g., last user profile state)

The user data will be stored primarily in 1 (and cached in 2), but the profile data will be stored in both 1 and 2.

## Users

### MongoDB

The `users` collection in the `mpgdata` MongoDB:

- `email_hash` (string - hashed email) - hashed using `SHA256` (`dude@dev.null => 5e64eab91e34c4d6eddc1f515f9ce81dea8238249f0946d40e3fc9ca22b7031a`)
- `ipfs` (string) - the IPFS CID address for latest profile_list
- `ipns` (string) - the IPNS address generated for a new user
- `last_login` (number - Unix timestamp) - last time the user logged in
- `password` (string - hashed password) - hashed using [`brcryptjs`](https://www.npmjs.com/package/bcryptjs)
- `profiles` (array of strings) - each string is a unique identifier of a JSON Schema profile instance
- `cuid` (string - generated by [`cuid`](https://www.npmjs.com/package/cuid)) - unique identifier for ipfs/ipns

```
{
  "email_hash":"5e64eab91e34c4d6eddc1f515f9ce81dea8238249f0946d40e3fc9ca22b7031a",
  "ipfs": "bafkreihggskujjuvtbyn6w3r7rhyinnena3jwufclhwgwgprr3jc4il5nq",
  "ipns": "k51qzi5uqu5dlkdgdggq0bm55cqojoqek4rfinvyx48d4mapmpin9ebhnjv49n",
  "last_login": 1652814514172,
  "password": "$2a$10$YzTuuQJfthIxVja/WZGh5OxjhSeMqQnG2xtOSUMAP41oTBkpNrMRq",
  "profiles": ["cjld2cjxh0000qzrmn831i7rn","cjld2cyuq0000t3rmniod1foy"],
  "cuid": "cl4u21lu20000ts9k878j0n1b"
}
```

## Profiles

### MongoDB

The `profiles` collection in the `mpgdata` MongoDB:

- `cuid` (string - generated by [`cuid`](https://www.npmjs.com/package/cuid)) - unique identifier of the JSON Schema profile instance
- `ipfs` (array of strings) - IPFS addresses of the profile instance (push each new IPFS address whenever profile is updated)
- `last_updated` (number - Unix timestamp) - last time the user modified (or created) the profile
- `linked_schemas` (array of strings) - the schema(s) the profile must be validated against
- `node_id` (string) - the node_id from mumurationsServices
- `title` (string) - a memorable/identifiable title to its author

```
{
  "cuid": "cjld2cjxh0000qzrmn831i7rn",
  "ipfs": ["bafybeif3kgstillrp22zqhq5occk6tyo2u2qa4e7s2yqpkia6ex2r3n23u"],
  "last_updated": 1654738391000,
  "linked_schemas": ["test_schema-v2.0.0"],
  "node_id": "640d836a14aab5de53f14281b724bb3042f07baabd6873a3b9907d0dd18a035e",
  "profile": "{\"linked_schemas\":[\"test_schema-v2.0.0\"],\"name\":\"The Dude\",\"latitude\":1,\"longitude\":1}",
  "title": "My first test profile"
}
```

### IPFS

The value is just the profile itself:

```
{"linked_schemas":["test_schema-v2.0.0"],"name":"The Dude","latitude":1,"longitude":1}
```

The IPFS address is generated by hashing the profile, and an array of IPFS addresses for the profile are stored in the profile record, thus recording the sequence of changes to that profile.
